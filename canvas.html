<!doctype html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="utf-8">
  <title>Canvas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
canvas {
    border: 1px solid black;
}
  </style>
  <script type="text/javascript" src="assets/js/paper-core.min.js"></script>
  <script type="text/javascript">
var is_pause = false;

//Generator function for Halton sequence
//https://en.wikipedia.org/wiki/Halton_sequence
var halton_sequence = function*(b) {
  var n = 0, d = 1;
  while (true) {
    var x = d - n;
    if (x == 1) {
      n = 1;
      d *= b;
    } else {
      y = Math.floor(d / b);
      while (x <= y) {
        y = Math.floor(y / b);
      }
      n = (b + 1) * y - x;
    }
    yield n / d;
  }
};

var halton_2 = halton_sequence(2);
var halton_3 = halton_sequence(3);

var haltonPoint = function() {
  x = halton_2.next().value
  y = halton_3.next().value;
  return new Point(x, y);
}

var fade = function() {
  var items = project.getItems({class: Path});
  for (var i = 0; i < items.length; i++) {
    if (items[i].fillColor) {
      items[i].fillColor.alpha -= 0.01;
      if (items[i].fillColor.alpha <= 0) {
        items[i].remove();
      }
    }
    if (items[i].strokeColor) {
      items[i].strokeColor.alpha -= 0.01;
      if (items[i].strokeColor.alpha <= 0) {
        items[i].remove();
      }
    }
  }
}

var away = function() {
  var center = new Point(256, 256);
  var items = project.getItems({class: Path});
  for (var i = 0; i < items.length; i++) {
    var r = items[i].bounds.width;
    var scale = 1 - r * 0.001;
    items[i].scale(scale, center);
  }
}

var randomPoint = function(p, r) {
  var ret = p.add(Point.random().multiply(new Point(2 * r, 2 * r)).subtract(new Point(r, r)));
  if (ret.x > 512) {
    ret.x = 512 - Math.random() * r;
  }
  if (ret.x < 0) {
    ret.x = Math.random() * r;
  }
  if (ret.y > 512) {
    ret.y = 512 - Math.random() * r;
  }
  if (ret.y < 0) {
    ret.y = Math.random() * r;
  }
  return ret;
}

var angle = function(p1, p2, p3) {
  var p21 = p2.subtract(p1);
  var p23 = p2.subtract(p3);
  return p21.getAngle(p23);
}

var drawRandom = function() {
  var path = new Path.Circle(Point.random().multiply(new Point(512, 512)), 2);
  path.fillColor = Color(0, 1);
}

var drawRandom2 = function() {
  fade();
  away();
  var center = new Point(256, 256);
  //project.activeLayer.rotate(0.5, center);
  var items = project.getItems({class: Path});
  for (var i = 0; i < items.length; i++) {
    var p = items[i].position;
    var d = p.subtract(center).length;
    items[i].rotate(d * 0.005, center);
  }
  var path = new Path.Circle(Point.random().multiply(new Point(512, 512)), Math.random() * 20);
  path.fillColor = Color(0, 1);
}

var drawRandom3 = function() {
  //fade();
  
  if (!project.activeLayer.children['path']) {
    var path = new Path();
    path.name = 'path';
    path.strokeColor = Color(0, 1);
    path.strokeWidth = 3;
    path.add(Point.random().multiply(new Point(512, 512)));
  }
  
  var path = project.activeLayer.children['path'];
  path.add(randomPoint(path.lastSegment.point, 200));
  if (path.segments.length > 50) {
    path.removeSegment(0);
  }
  path.smooth();
}

var drawHalton = function() {
  var path = new Path.Circle(haltonPoint().multiply(new Point(512, 512)), 2);
  path.fillColor = Color(0, 1);
}

var drawConnection = function() {
  if (!project.activeLayer.children['path']) {
    var path = new Path();
    path.name = 'path';
    path.strokeColor = Color(0, 1);
    path.strokeWidth = 3;
    path.strokeJoin = 'round';
    path.add(Point.random().multiply(new Point(512, 512)));
    path.add(Point.random().multiply(new Point(512, 512)));
    path.add(Point.random().multiply(new Point(512, 512)));
    path.closed = true;
  }
  var path = project.activeLayer.children['path'];

  while (1) {
    var idx = Math.floor(Math.random() * path.curves.length);
    var curve = path.curves[idx];
    var mid = curve.getPointAt(curve.length/2);
    var p = randomPoint(mid, 100);
    if (angle(curve.point1, p, curve.point2) < 10) {
      continue;
    }
    if (angle(curve.previous.point1, curve.point1, p) < 10) {
      continue;
    }
    if (angle(p, curve.point2, curve.next.point2) < 10) {
      continue;
    }
    var new_path = new Path([curve.point1, p, curve.point2]);
    new_path.closed = true;
    var intersections = path.getIntersections(new_path);
    if (intersections.length == 2) {
      var np = path.getNearestPoint(p);
      if (np.subtract(p).length > 10) {
        path.insert(curve.segment1.index + 1, p);
        break;
      }
    }
  }

  if (path.segments.length > 200) {
    restart();
  }
}

var pause = function() {
  is_pause = true;
}

var resume = function() {
  is_pause = false;
}

var restart = function() {
  project.clear();
  is_pause = false;
}

var run = function(f) {
  drawFunction = f;
  restart();
}

var drawFunction = drawRandom;

var drawLoop = function() {
  if (!is_pause) {
    drawFunction();
  }
}

paper.install(window);
window.onload = function() {
  var canvas = document.querySelector('canvas')
  paper.setup(canvas);
  view.onFrame = drawLoop;
  view.onClick = () => is_pause = !is_pause;
}
  </script>
</head>

<body>
  <div>
    <canvas width="512" height="512"></canvas>
  </div>
  <div>
    <button onclick="restart()">Restart</button>
    <button onclick="resume()">Resume</button>
    <button onclick="pause()">Pause</button>
  </div>
  <div>
    <button onclick="run(drawRandom)">Random</button>
    <button onclick="run(drawRandom2)">Random2</button>
    <button onclick="run(drawRandom3)">Random3</button>
    <button onclick="run(drawHalton)">Halton</button>
    <button onclick="run(drawConnection)">Connection</button>
  </div>
</body>

</html>
